@page
@model FitraLife.Pages.Dashboard.IndexModel
@using FitraLife.Models
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid px-4 py-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bold text-secondary mb-1">Dashboard</h1>
            <p class="text-muted mb-0">Welcome back, <span class="text-primary fw-bold">@Model.CurrentUser?.UserName</span>! Here's your daily breakdown.</p>
        </div>
        <a asp-page="/FitnessLogs/Create" class="btn btn-primary btn-lg shadow-sm">
            <span class="me-2">‚ûï</span> Log Activity
        </a>
    </div>

    @if (TempData["StatusMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm border-0 mb-4" role="alert">
            @TempData["StatusMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- ======================= PREDICTIVE ANALYTICS ======================= -->
    @if (Model.Prediction != null)
    {
        <div class="card border-0 shadow-sm mb-5 bg-primary text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <h4 class="fw-bold mb-0 me-2">üöÄ Target Weight Predictor</h4>
                            <button type="button" class="btn btn-sm btn-link text-white p-0 opacity-75" data-bs-toggle="modal" data-bs-target="#predictionInfoModal" title="How does this work?">
                                <i class="bi bi-info-circle-fill"></i>
                            </button>
                        </div>
                        <p class="mb-3 opacity-90 fs-5">@Model.Prediction.Message</p>
                        
                        @if (Model.Prediction.PredictedDate.HasValue)
                        {
                            <div class="d-flex align-items-center p-3 rounded bg-white bg-opacity-10 border border-white border-opacity-10">
                                <div class="me-3">
                                    <i class="bi bi-calendar-check fs-2"></i>
                                </div>
                                <div>
                                    <small class="text-uppercase opacity-75 fw-bold" style="letter-spacing: 1px;">Estimated Completion</small>
                                    <div class="h3 fw-bold mb-0">@Model.Prediction.PredictedDate.Value.ToString("MMMM dd, yyyy")</div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="col-md-4 text-center text-md-end mt-4 mt-md-0">
                        <div class="d-inline-block p-4 rounded-circle bg-white bg-opacity-10 backdrop-blur">
                            @if (Model.Prediction.IsOnTrack)
                            {
                                <div class="display-4 mb-0">üéØ</div>
                            }
                            else
                            {
                                <div class="display-4 mb-0">‚ö†Ô∏è</div>
                            }
                        </div>
                        <div class="mt-2 fw-bold opacity-75">
                            @(Model.Prediction.IsOnTrack ? "Trend looks good!" : "Adjustment needed")
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- ======================= TODAY'S HIGHLIGHTS ======================= -->
    @if (Model.CurrentUser != null)
    {
        <div class="row g-4 mb-5">
            <!-- Today's Steps -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body p-4 position-relative">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <p class="text-muted fw-semibold small text-uppercase mb-1">Steps Today</p>
                                <h2 class="fw-bold mb-0">@($"{Model.LatestLog?.Steps ?? 0:N0}")</h2>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                                üë£
                            </div>
                        </div>
                        <div class="progress" style="height: 6px;">
                            @{
                                var dailyStepPercent = Model.StepGoal > 0 ? Math.Min(100, ((double)(Model.LatestLog?.Steps ?? 0) / (Model.StepGoal / 7.0)) * 100) : 0;
                            }
                            <div class="progress-bar bg-primary" style="width: @dailyStepPercent%"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">Target: @($"{Model.StepGoal / 7:N0}") / day</small>
                    </div>
                </div>
            </div>

            <!-- Calories Burned -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <div class="d-flex align-items-center gap-2">
                                    <p class="text-muted fw-semibold small text-uppercase mb-1">Calories Burned</p>
                                    <button type="button" class="btn btn-link p-0 text-muted opacity-50" style="font-size: 0.85rem;" data-bs-toggle="modal" data-bs-target="#tdeeInfoModal">
                                        <i class="bi bi-info-circle-fill"></i>
                                    </button>
                                </div>
                                <h2 class="fw-bold text-success mb-0">@($"{Model.LatestLog?.CaloriesBurned ?? 0:N0}")</h2>
                            </div>
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                                üî•
                            </div>
                        </div>
                        <p class="mb-0 text-muted small">Active energy expenditure</p>
                    </div>
                </div>
            </div>

            <!-- Calories Eaten -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <p class="text-muted fw-semibold small text-uppercase mb-1">Calories Eaten</p>
                                <h2 class="fw-bold text-danger mb-0">@($"{Model.LatestLog?.CaloriesEaten ?? 0:N0}")</h2>
                            </div>
                            <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger">
                                ü•ó
                            </div>
                        </div>
                         <p class="mb-0 text-muted small">Total intake today</p>
                    </div>
                </div>
            </div>

            <!-- Workout Time -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <p class="text-muted fw-semibold small text-uppercase mb-1">Workout Time</p>
                                <h2 class="fw-bold text-warning mb-0">@($"{Model.LatestLog?.WorkoutMinutes ?? 0:N0}") <span class="fs-6 text-muted fw-normal">min</span></h2>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                                ‚è±Ô∏è
                            </div>
                        </div>
                        <p class="mb-0 text-muted small">Duration of exercise</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="row g-4 mb-5">
        <!-- ======================= WEEKLY GOALS WIDGET ======================= -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Weekly Progress</h5>
                    <span class="badge bg-light text-dark border">Last 7 Days</span>
                </div>
                <div class="card-body p-4">
                    @if (Model.FitnessLogs.Any())
                    {
                        <div class="row g-4">
                            <!-- Steps Goal -->
                            <div class="col-md-6">
                                <div class="p-3 rounded-3 bg-light border-0 h-100">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-semibold">Steps Goal</span>
                                        @{ var stepPercent = Math.Min(100, (Model.WeeklySteps / Model.StepGoal) * 100); }
                                        <span class="fw-bold text-primary">@($"{stepPercent:N0}%")</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-primary" style="width:@($"{Math.Max(stepPercent, 2)}%")"></div>
                                    </div>
                                    <small class="text-muted">@($"{Model.WeeklySteps:N0} / {Model.StepGoal:N0} steps")</small>
                                </div>
                            </div>

                            <!-- Workout Goal -->
                            <div class="col-md-6">
                                <div class="p-3 rounded-3 bg-light border-0 h-100">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-semibold">Workout Goal</span>
                                        @{ var workoutPercent = Math.Min(100, (Model.WeeklyWorkoutMinutes / Model.WorkoutMinutesGoal) * 100); }
                                        <span class="fw-bold text-warning">@($"{workoutPercent:N0}%")</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-warning" style="width:@($"{Math.Max(workoutPercent, 2)}%")"></div>
                                    </div>
                                    <small class="text-muted">@($"{Model.WeeklyWorkoutMinutes:N0} / {Model.WorkoutMinutesGoal:N0} min")</small>
                                </div>
                            </div>

                            <!-- Calorie Intake -->
                            <div class="col-md-6">
                                <div class="p-3 rounded-3 bg-light border-0 h-100">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-semibold">Calorie Limit</span>
                                        @{ var eatPercent = Model.WeeklyEatGoal > 0 ? Math.Min(100, (Model.WeeklyCaloriesEaten / Model.WeeklyEatGoal) * 100) : 0; }
                                        <span class="fw-bold text-danger">@($"{eatPercent:N0}%")</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-danger" style="width:@($"{Math.Max(eatPercent, 2)}%")"></div>
                                    </div>
                                    <small class="text-muted">@($"{Model.WeeklyCaloriesEaten:N0} / {Model.WeeklyEatGoal:N0} kcal")</small>
                                </div>
                            </div>

                            <!-- Calorie Burn -->
                            <div class="col-md-6">
                                <div class="p-3 rounded-3 bg-light border-0 h-100">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-semibold">Burn Target</span>
                                        @{
                                            double weeklyBurnGoal = 0;
                                            var u = Model.CurrentUser;
                                            if (u != null && u.Weight > 0) {
                                                // Simple BMR calc for display logic (same as before)
                                                double bmr = u.Gender == "Male" ? 10 * u.Weight + 6.25 * u.Height - 5 * u.Age + 5 : 10 * u.Weight + 6.25 * u.Height - 5 * u.Age - 161;
                                                double activity = u.ActivityLevel switch { "Sedentary" => 1.2, "Light" => 1.375, "Moderate" => 1.55, "Active" => 1.725, _ => 1.55 };
                                                double dailyGoal = (bmr * activity) + (u.GoalType == "Lose" ? -500 : u.GoalType == "Gain" ? 500 : 0);
                                                weeklyBurnGoal = (dailyGoal * 7) * 0.6;
                                            }
                                            var burnPercent = weeklyBurnGoal > 0 ? Math.Min(100, (Model.WeeklyCaloriesBurned / weeklyBurnGoal) * 100) : 0;
                                        }
                                        <span class="fw-bold text-success">@($"{burnPercent:N0}%")</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-success" style="width:@($"{Math.Max(burnPercent, 2)}%")"></div>
                                    </div>
                                    <small class="text-muted">@($"{Model.WeeklyCaloriesBurned:N0} / {weeklyBurnGoal:N0} kcal")</small>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">No activity logged this week yet.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- ======================= PROFILE CARD ======================= -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4 text-center">
                    <div class="mb-4">
                        <div class="d-inline-block p-1 rounded-circle border border-2 border-primary mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; font-size: 2rem;">
                                @Model.CurrentUser?.UserName?.Substring(0,1).ToUpper()
                            </div>
                        </div>
                        <h4 class="fw-bold mb-1">@Model.CurrentUser?.UserName</h4>
                        <p class="text-muted mb-3">@Model.CurrentUser?.FitnessGoal</p>
                        <a href="/Profile/Index" class="btn btn-outline-primary btn-sm rounded-pill px-4">Edit Profile</a>
                    </div>

                    <div class="row g-2 text-start">
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Weight</small>
                                <span class="fw-bold text-dark">@($"{Model.CurrentUser?.Weight:N1} kg")</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">BMI</small>
                                <span class="fw-bold text-dark">@($"{Model.CurrentUser?.BMI:N1}")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= CHARTS SECTION ======================= -->
    @if (Model.FitnessLogs.Any())
    {
        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0">
                        <h5 class="fw-bold mb-0">Activity Trends</h5>
                    </div>
                    <div class="card-body p-4">
                        <div style="height: 300px;">
                            <canvas id="stepsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0">
                        <h5 class="fw-bold mb-0">Calorie Balance</h5>
                    </div>
                    <div class="card-body p-4">
                        <div style="height: 300px;">
                            <canvas id="caloriesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================= RECENT LOGS TABLE ======================= -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">Recent History</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 py-3 ps-4">Date</th>
                                <th class="border-0 py-3">Steps</th>
                                <th class="border-0 py-3">Burned</th>
                                <th class="border-0 py-3">Eaten</th>
                                <th class="border-0 py-3">Workout</th>
                                <th class="border-0 py-3 pe-4 text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in Model.FitnessLogs.OrderByDescending(l => l.Date).Take(5))
                            {
                                <tr>
                                    <td class="ps-4 fw-semibold text-muted">@log.Date.ToString("MMM dd, yyyy")</td>
                                    <td><span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">@($"{log.Steps:N0}")</span></td>
                                    <td class="text-success fw-semibold">@($"{log.CaloriesBurned:N0}") kcal</td>
                                    <td class="text-danger fw-semibold">@($"{log.CaloriesEaten:N0}") kcal</td>
                                    <td>@($"{log.WorkoutMinutes:N0}") min</td>
                                    <td class="pe-4 text-end">
                                        <a asp-page="/FitnessLogs/Edit" asp-route-id="@log.Id" class="btn btn-icon btn-sm btn-light text-muted" title="Edit">‚úèÔ∏è</a>
                                        <a asp-page="/FitnessLogs/Delete" asp-route-id="@log.Id" class="btn btn-icon btn-sm btn-light text-danger ms-1" title="Delete">üóëÔ∏è</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    @{
        var chartData = Model.FitnessLogs.Select(l => new {
            date = l.Date.ToString("yyyy-MM-dd"),
            steps = l.Steps,
            caloriesBurned = l.CaloriesBurned,
            caloriesEaten = l.CaloriesEaten
        });
    }

    <script>
        const logs = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(chartData));
        if (logs && logs.length > 0) {
            logs.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = logs.map(l => new Date(l.date).toLocaleDateString());
            const steps = logs.map(l => l.steps);
            const caloriesBurned = logs.map(l => l.caloriesBurned);
            const caloriesEaten = logs.map(l => l.caloriesEaten);

            Chart.defaults.font.family = "Inter, system-ui, sans-serif";
            
            // Static colors for single theme (Dark Mode)
            const textColor = '#f3f4f6';
            const gridColor = 'rgba(255,255,255,0.1)';

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            const stepsChart = new Chart(document.getElementById('stepsChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Steps',
                        data: steps,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            ticks: { color: textColor },
                            grid: { color: gridColor, display: false } 
                        },
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: textColor },
                            grid: { color: gridColor, borderDash: [5, 5] } 
                        }
                    }
                }
            });

            const caloriesChart = new Chart(document.getElementById('caloriesChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { 
                            label: 'Calories Burned', 
                            data: caloriesBurned, 
                            backgroundColor: '#10b981', 
                            borderRadius: 4,
                            barPercentage: 0.6
                        },
                        { 
                            label: 'Calories Eaten', 
                            data: caloriesEaten, 
                            backgroundColor: '#ef4444', 
                            borderRadius: 4,
                            barPercentage: 0.6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            labels: { color: textColor, usePointStyle: true } 
                        } 
                    },
                    scales: {
                        x: { 
                            ticks: { color: textColor },
                            grid: { display: false } 
                        },
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: textColor },
                            grid: { color: gridColor, borderDash: [5, 5] } 
                        }
                    }
                }
            });
        }
    </script>
}

<!-- ======================= INFO MODALS ======================= -->

<!-- TDEE Info Modal -->
<div class="modal fade" id="tdeeInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-primary">Daily Energy Expenditure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="display-6 fw-bold text-dark mb-1">@($"{Model.EstimatedTDEE:N0}") <span class="fs-5 text-muted">kcal</span></div>
                    <small class="text-muted text-uppercase fw-bold">Your Estimated Daily Burn</small>
                </div>
                
                <div class="alert alert-light border rounded-3 mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Base Metabolic Rate (BMR)</span>
                        <span class="fw-bold">@($"{Model.EstimatedBMR:N0}") kcal</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Activity Level (@Model.CurrentUser?.ActivityLevel)</span>
                        <span class="fw-bold text-success">+@($"{Model.EstimatedTDEE - Model.EstimatedBMR:N0}") kcal</span>
                    </div>
                </div>

                <p class="small text-muted mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    This is calculated using the <strong>Mifflin-St Jeor Equation</strong> based on your profile. 
                    When logging "Calories Burned", try to include your active exercise on top of this base number, or log your total daily expenditure.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Prediction Info Modal -->
<div class="modal fade" id="predictionInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-primary">How Prediction Works</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-3 text-black">Our <strong>Target Weight Predictor</strong> uses your recent data to forecast your success.</p>
                
                <div class="list-group list-group-flush mb-3">
                    <div class="list-group-item px-0">
                        <h6 class="fw-bold mb-1 text-black">1. Data Analysis</h6>
                        <p class="small text-secondary mb-0">We analyze your recent logs to find your average daily calorie deficit or surplus.</p>
                    </div>
                    <div class="list-group-item px-0">
                        <h6 class="fw-bold mb-1 text-black">2. The Math (7700 Rule)</h6>
                        <p class="small text-secondary mb-0">Science suggests that a deficit of ~7,700 calories results in 1kg of weight loss. We apply this constant to your average deficit.</p>
                    </div>
                    <div class="list-group-item px-0">
                        <h6 class="fw-bold mb-1 text-black">3. Linear Projection</h6>
                        <p class="small text-secondary mb-0">We project this trend forward linearly to calculate the exact date you will hit your target weight of <strong>@Model.CurrentUser?.TargetWeight kg</strong>.</p>
                    </div>
                </div>

                <div class="alert alert-primary bg-opacity-10 border-0 rounded-3 small mb-0 text-black">
                    <strong>Note:</strong> This is a mathematical model. Real-world weight loss is non-linear and affected by water retention, sleep, and hormones.
                </div>
            </div>
        </div>
    </div>
</div>
